"use strict";
// SPDX-FileCopyrightText: 2023 Alliander NV
//
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const client_kms_1 = require("@aws-sdk/client-kms");
const client_s3_1 = require("@aws-sdk/client-s3");
const index_keyrotate_1 = require("../index.keyrotate");
const kmsMock = (0, aws_sdk_client_mock_1.mockClient)(client_kms_1.KMSClient);
const s3Mock = (0, aws_sdk_client_mock_1.mockClient)(client_s3_1.S3Client);
const pubKeys = {
    PREVIOUS: {
        pem: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt0O+biOuAYD5FrM2R6dAliN1v9HA5XpsuoAtXTn8OVKsLvvBFEhBFlghvSXPpu71vE/JYpUj0lL7J54o/RmCz9ZRDzojLU7aWEYM2sEC9nO2ITdu8it+rr3faa70+7PGW09o4iFD+mXYUgadYT8VWxrKQ3eV/LQrSM+6/KYl3BhlNZNxwjtbHGWAldOlzvy14I59GU5W/zDPgOIWSQBbpRvoJKT2rzOZYDtn7C62197hJYAU7QIZ4mOz/ia10ayFFI7p2Uogku3tY5cyYEtSWGzlTL3EiEzSvvsfQ0717bA5ybbDqCWtShg8+IoOxmby4K9X7XuGAQZYE/fgNAXg3wIDAQAB',
        jwk_kid: 'reND9IAI5hj2pe8UfKm2X6r-SjW1v7s23oC3_N5WPiQ'
    },
    CURRENT: {
        pem: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA/PC3f+8XOs6yway2FhPLdZrWU67RIqFACSPJ0A4q/eJ8GlGXDj8cxHcJBJyvTxEU/rttSe3f44ZfrvwlDUbgAmTi2zYEDrBRHr+LmR6qoyvczLNZkiMmJZygdeOMT87gPx1fb8hhFAXQkOL8dHKiBZ+s4Hls8yu5eMuBhjh+hUYxEQWw0ilDgaXCaGRjooHPSU6+I+Qbm73MuCbBAyzSIAGDKyyD50Kx9Z9Cc0i+6ZfXwWU/2Sda7u4U4R2B/PkhAy0fIjn7kMaw9sgpdQHHxygxQ8y7PduNgDBF/C1zOeKJuRa3QGoMXY9kn/OVBwnZG7bQ9Enz3RnTkM3q0nf9JQIDAQAB',
        jwk_kid: '-NIJE4RQ8NYWrOOh5_JyGKFAobfY5_oCKo1MrNXoQOg'
    },
    PENDING: {
        pem: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzeWAt2aRiX57vDd78OwF+83IdEI0mWh05hXvAzQXMqt+QR49hiIWjJtYh1B3sYvbp9BWC8yo+BlWWtsI5fu5mCXsBBp/Q/sgfArEsji+dWEXc+xGRN3hptb9tT+sabIWmd6Qyw4dYCksrBzJvSLO+Hi10Otd2NtzYbAqjZ6soaaClSnrOiw9+J4/GFHuY5gOw8P0uaMclI5sDLGN+G/ayGpUK7xegfEAd9VB6mhdgWoYEAT6yEDnFt0BwvTOYT6TI/5v6scRE7Bywsq5V2Mz5VZe43POcSt1n7vIZ9cXXHSGW8JPv1KKcniHsxIc3Fc74OjcEbqWKw49kVGCE3ayfQIDAQAB',
        jwk_kid: 'bHyjPYB3AfII8o_X3tGkOCVzThZzQN2UKwKVCO9E9gY'
    }
};
describe('handlers/keyrotate/keyrotate.test.ts', () => {
    const OLD_ENV = process.env;
    beforeEach(() => {
        jest.resetModules();
        kmsMock.reset();
        s3Mock.reset();
        process.env = { ...OLD_ENV };
    });
    afterEach(() => {
        kmsMock.reset();
        s3Mock.reset();
        process.env = OLD_ENV;
    });
    test('should generate & upload correct JWKS file to S3', async () => {
        kmsMock
            .on(client_kms_1.GetPublicKeyCommand, { KeyId: 'alias/sts/PREVIOUS' }).resolves({
            PublicKey: base64ToArrayBuffer(pubKeys.PREVIOUS.pem)
        })
            .on(client_kms_1.GetPublicKeyCommand, { KeyId: 'alias/sts/CURRENT' }).resolves({
            PublicKey: base64ToArrayBuffer(pubKeys.CURRENT.pem)
        })
            .on(client_kms_1.GetPublicKeyCommand, { KeyId: 'alias/sts/PENDING' }).resolves({
            PublicKey: base64ToArrayBuffer(pubKeys.PENDING.pem)
        })
            .on(client_kms_1.DescribeKeyCommand, { KeyId: 'alias/sts/PREVIOUS' }).resolves({
            KeyMetadata: {
                KeyId: 'key-1'
            }
        })
            .on(client_kms_1.DescribeKeyCommand, { KeyId: 'alias/sts/CURRENT' }).resolves({
            KeyMetadata: {
                KeyId: 'key-2'
            }
        })
            .on(client_kms_1.DescribeKeyCommand, { KeyId: 'alias/sts/PENDING' }).resolves({
            KeyMetadata: {
                KeyId: 'key-3'
            }
        });
        process.env.S3_BUCKET = 'test-bucket-name';
        process.env.ISSUER = 'test-issuer.com';
        await (0, index_keyrotate_1.handler)({ step: 'generateArtifacts' });
        // @ts-ignore
        const tagsPrevious = kmsMock.call(2).args[0].input.Tags;
        expect(tagsPrevious[0].TagKey).toBe('jwk_kid');
        expect(tagsPrevious[0].TagValue).toBe(pubKeys.PREVIOUS.jwk_kid);
        // @ts-ignore
        const tagsCurrent = kmsMock.call(5).args[0].input.Tags;
        expect(tagsCurrent[0].TagKey).toBe('jwk_kid');
        expect(tagsCurrent[0].TagValue).toBe(pubKeys.CURRENT.jwk_kid);
        // @ts-ignore
        const tagsPending = kmsMock.call(8).args[0].input.Tags;
        expect(tagsPending[0].TagKey).toBe('jwk_kid');
        expect(tagsPending[0].TagValue).toBe(pubKeys.PENDING.jwk_kid);
        // @ts-ignore
        const s3Key = s3Mock.call(0).args[0].input.Key;
        expect(s3Key).toBe('discovery/keys');
        // @ts-ignore
        const s3Bucket = s3Mock.call(0).args[0].input.Bucket;
        expect(s3Bucket).toBe('test-bucket-name');
        // @ts-ignore
        const s3Body = JSON.parse(s3Mock.call(0).args[0].input.Body.toString());
        expect(s3Body).toEqual({
            keys: [
                {
                    e: 'AQAB',
                    kid: 'reND9IAI5hj2pe8UfKm2X6r-SjW1v7s23oC3_N5WPiQ',
                    kty: 'RSA',
                    n: 't0O-biOuAYD5FrM2R6dAliN1v9HA5XpsuoAtXTn8OVKsLvvBFEhBFlghvSXPpu71vE_JYpUj0lL7J54o_RmCz9ZRDzojLU7aWEYM2sEC9nO2ITdu8it-rr3faa70-7PGW09o4iFD-mXYUgadYT8VWxrKQ3eV_LQrSM-6_KYl3BhlNZNxwjtbHGWAldOlzvy14I59GU5W_zDPgOIWSQBbpRvoJKT2rzOZYDtn7C62197hJYAU7QIZ4mOz_ia10ayFFI7p2Uogku3tY5cyYEtSWGzlTL3EiEzSvvsfQ0717bA5ybbDqCWtShg8-IoOxmby4K9X7XuGAQZYE_fgNAXg3w',
                    alg: 'RS256',
                    use: 'sig'
                }, {
                    e: 'AQAB',
                    kid: '-NIJE4RQ8NYWrOOh5_JyGKFAobfY5_oCKo1MrNXoQOg',
                    kty: 'RSA',
                    n: '_PC3f-8XOs6yway2FhPLdZrWU67RIqFACSPJ0A4q_eJ8GlGXDj8cxHcJBJyvTxEU_rttSe3f44ZfrvwlDUbgAmTi2zYEDrBRHr-LmR6qoyvczLNZkiMmJZygdeOMT87gPx1fb8hhFAXQkOL8dHKiBZ-s4Hls8yu5eMuBhjh-hUYxEQWw0ilDgaXCaGRjooHPSU6-I-Qbm73MuCbBAyzSIAGDKyyD50Kx9Z9Cc0i-6ZfXwWU_2Sda7u4U4R2B_PkhAy0fIjn7kMaw9sgpdQHHxygxQ8y7PduNgDBF_C1zOeKJuRa3QGoMXY9kn_OVBwnZG7bQ9Enz3RnTkM3q0nf9JQ',
                    alg: 'RS256',
                    use: 'sig'
                }, {
                    e: 'AQAB',
                    kid: 'bHyjPYB3AfII8o_X3tGkOCVzThZzQN2UKwKVCO9E9gY',
                    kty: 'RSA',
                    n: 'zeWAt2aRiX57vDd78OwF-83IdEI0mWh05hXvAzQXMqt-QR49hiIWjJtYh1B3sYvbp9BWC8yo-BlWWtsI5fu5mCXsBBp_Q_sgfArEsji-dWEXc-xGRN3hptb9tT-sabIWmd6Qyw4dYCksrBzJvSLO-Hi10Otd2NtzYbAqjZ6soaaClSnrOiw9-J4_GFHuY5gOw8P0uaMclI5sDLGN-G_ayGpUK7xegfEAd9VB6mhdgWoYEAT6yEDnFt0BwvTOYT6TI_5v6scRE7Bywsq5V2Mz5VZe43POcSt1n7vIZ9cXXHSGW8JPv1KKcniHsxIc3Fc74OjcEbqWKw49kVGCE3ayfQ',
                    alg: 'RS256',
                    use: 'sig'
                }
            ]
        });
        // @ts-ignore
        const s3KeyOpenidConfiguration = s3Mock.call(1).args[0].input.Key;
        expect(s3KeyOpenidConfiguration).toBe('.well-known/openid-configuration');
        // @ts-ignore
        const s3BodyOpenidConfiguration = JSON.parse(s3Mock.call(1).args[0].input.Body.toString());
        expect(s3BodyOpenidConfiguration).toEqual({
            issuer: 'test-issuer.com',
            jwks_uri: 'test-issuer.com/discovery/keys',
            response_types_supported: [
                'token'
            ],
            id_token_signing_alg_values_supported: [
                'RS256'
            ],
            scopes_supported: [
                'openid'
            ],
            token_endpoint_auth_methods_supported: [
                'client_secret_basic'
            ],
            claims_supported: [
                'aud',
                'exp',
                'iat',
                'iss',
                'sub'
            ]
        });
    });
});
function base64ToArrayBuffer(b64) {
    const byteString = atob(b64);
    const byteArray = new Uint8Array(byteString.length);
    for (let i = 0; i < byteString.length; i++) {
        byteArray[i] = byteString.charCodeAt(i);
    }
    return byteArray;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgua2V5cm90YXRlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGVzdC9pbmRleC5rZXlyb3RhdGUudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNENBQTRDO0FBQzVDLEVBQUU7QUFDRixzQ0FBc0M7O0FBRXRDLDZEQUFnRDtBQUNoRCxvREFBd0Y7QUFDeEYsa0RBQTZDO0FBRTdDLHdEQUE0QztBQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFBLGdDQUFVLEVBQUMsc0JBQVMsQ0FBQyxDQUFBO0FBQ3JDLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0NBQVUsRUFBQyxvQkFBUSxDQUFDLENBQUE7QUFFbkMsTUFBTSxPQUFPLEdBQUc7SUFDZCxRQUFRLEVBQUU7UUFDUixHQUFHLEVBQUUsMFlBQTBZO1FBQy9ZLE9BQU8sRUFBRSw2Q0FBNkM7S0FDdkQ7SUFDRCxPQUFPLEVBQUU7UUFDUCxHQUFHLEVBQUUsMFlBQTBZO1FBQy9ZLE9BQU8sRUFBRSw2Q0FBNkM7S0FDdkQ7SUFDRCxPQUFPLEVBQUU7UUFDUCxHQUFHLEVBQUUsMFlBQTBZO1FBQy9ZLE9BQU8sRUFBRSw2Q0FBNkM7S0FDdkQ7Q0FDRixDQUFBO0FBRUQsUUFBUSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtJQUNwRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFBO0lBRTNCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDbkIsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2YsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2QsT0FBTyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUE7SUFDOUIsQ0FBQyxDQUFDLENBQUE7SUFFRixTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2YsTUFBTSxDQUFDLEtB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U0FDRixDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBO0FBRUYsU0FBUyxtQkFBbUIsQ0FBRSxHQUFXO0lBQ3ZDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUM1QixNQUFNLFNBQVMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDbkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMzQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN6QyxDQUFDO0lBRUQsT0FBTyxTQUFTLENBQUE7QUFDbEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgQWxsaWFuZGVyIE5WXG4vL1xuLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcblxuaW1wb3J0IHsgbW9ja0NsaWVudCB9IGZyb20gJ2F3cy1zZGstY2xpZW50LW1vY2snXG5pbXBvcnQgeyBLTVNDbGllbnQsIEdldFB1YmxpY0tleUNvbW1hbmQsIERlc2NyaWJlS2V5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1rbXMnXG5pbXBvcnQgeyBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMydcblxuaW1wb3J0IHsgaGFuZGxlciB9IGZyb20gJy4uL2luZGV4LmtleXJvdGF0ZSdcblxuY29uc3Qga21zTW9jayA9IG1vY2tDbGllbnQoS01TQ2xpZW50KVxuY29uc3QgczNNb2NrID0gbW9ja0NsaWVudChTM0NsaWVudClcblxuY29uc3QgcHViS2V5cyA9IHtcbiAgUFJFVklPVVM6IHtcbiAgICBwZW06ICdNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXQwTytiaU91QVlENUZyTTJSNmRBbGlOMXY5SEE1WHBzdW9BdFhUbjhPVktzTHZ2QkZFaEJGbGdodlNYUHB1NzF2RS9KWXBVajBsTDdKNTRvL1JtQ3o5WlJEem9qTFU3YVdFWU0yc0VDOW5PMklUZHU4aXQrcnIzZmFhNzArN1BHVzA5bzRpRkQrbVhZVWdhZFlUOFZXeHJLUTNlVi9MUXJTTSs2L0tZbDNCaGxOWk54d2p0YkhHV0FsZE9senZ5MTRJNTlHVTVXL3pEUGdPSVdTUUJicFJ2b0pLVDJyek9aWUR0bjdDNjIxOTdoSllBVTdRSVo0bU96L2lhMTBheUZGSTdwMlVvZ2t1M3RZNWN5WUV0U1dHemxUTDNFaUV6U3Z2c2ZRMDcxN2JBNXliYkRxQ1d0U2hnOCtJb094bWJ5NEs5WDdYdUdBUVpZRS9mZ05BWGczd0lEQVFBQicsXG4gICAgandrX2tpZDogJ3JlTkQ5SUFJNWhqMnBlOFVmS20yWDZyLVNqVzF2N3MyM29DM19ONVdQaVEnXG4gIH0sXG4gIENVUlJFTlQ6IHtcbiAgICBwZW06ICdNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQS9QQzNmKzhYT3M2eXdheTJGaFBMZFpyV1U2N1JJcUZBQ1NQSjBBNHEvZUo4R2xHWERqOGN4SGNKQkp5dlR4RVUvcnR0U2UzZjQ0WmZydndsRFViZ0FtVGkyellFRHJCUkhyK0xtUjZxb3l2Y3pMTlpraU1tSlp5Z2RlT01UODdnUHgxZmI4aGhGQVhRa09MOGRIS2lCWitzNEhsczh5dTVlTXVCaGpoK2hVWXhFUVd3MGlsRGdhWENhR1Jqb29IUFNVNitJK1FibTczTXVDYkJBeXpTSUFHREt5eUQ1MEt4OVo5Q2MwaSs2WmZYd1dVLzJTZGE3dTRVNFIyQi9Qa2hBeTBmSWpuN2tNYXc5c2dwZFFISHh5Z3hROHk3UGR1TmdEQkYvQzF6T2VLSnVSYTNRR29NWFk5a24vT1ZCd25aRzdiUTlFbnozUm5Ua00zcTBuZjlKUUlEQVFBQicsXG4gICAgandrX2tpZDogJy1OSUpFNFJROE5ZV3JPT2g1X0p5R0tGQW9iZlk1X29DS28xTXJOWG9RT2cnXG4gIH0sXG4gIFBFTkRJTkc6IHtcbiAgICBwZW06ICdNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXplV0F0MmFSaVg1N3ZEZDc4T3dGKzgzSWRFSTBtV2gwNWhYdkF6UVhNcXQrUVI0OWhpSVdqSnRZaDFCM3NZdmJwOUJXQzh5bytCbFdXdHNJNWZ1NW1DWHNCQnAvUS9zZ2ZBckVzamkrZFdFWGMreEdSTjNocHRiOXRUK3NhYklXbWQ2UXl3NGRZQ2tzckJ6SnZTTE8rSGkxME90ZDJOdHpZYkFxalo2c29hYUNsU25yT2l3OStKNC9HRkh1WTVnT3c4UDB1YU1jbEk1c0RMR04rRy9heUdwVUs3eGVnZkVBZDlWQjZtaGRnV29ZRUFUNnlFRG5GdDBCd3ZUT1lUNlRJLzV2NnNjUkU3Qnl3c3E1VjJNejVWWmU0M1BPY1N0MW43dklaOWNYWEhTR1c4SlB2MUtLY25pSHN4SWMzRmM3NE9qY0VicVdLdzQ5a1ZHQ0UzYXlmUUlEQVFBQicsXG4gICAgandrX2tpZDogJ2JIeWpQWUIzQWZJSThvX1gzdEdrT0NWelRoWnpRTjJVS3dLVkNPOUU5Z1knXG4gIH1cbn1cblxuZGVzY3JpYmUoJ2hhbmRsZXJzL2tleXJvdGF0ZS9rZXlyb3RhdGUudGVzdC50cycsICgpID0+IHtcbiAgY29uc3QgT0xEX0VOViA9IHByb2Nlc3MuZW52XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5yZXNldE1vZHVsZXMoKVxuICAgIGttc01vY2sucmVzZXQoKVxuICAgIHMzTW9jay5yZXNldCgpXG4gICAgcHJvY2Vzcy5lbnYgPSB7IC4uLk9MRF9FTlYgfVxuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAga21zTW9jay5yZXNldCgpXG4gICAgczNNb2NrLnJlc2V0KClcbiAgICBwcm9jZXNzLmVudiA9IE9MRF9FTlZcbiAgfSlcblxuICB0ZXN0KCdzaG91bGQgZ2VuZXJhdGUgJiB1cGxvYWQgY29ycmVjdCBKV0tTIGZpbGUgdG8gUzMnLCBhc3luYyAoKSA9PiB7XG4gICAga21zTW9ja1xuICAgICAgLm9uKEdldFB1YmxpY0tleUNvbW1hbmQsIHsgS2V5SWQ6ICdhbGlhcy9zdHMvUFJFVklPVVMnIH0pLnJlc29sdmVzKHtcbiAgICAgICAgUHVibGljS2V5OiBiYXNlNjRUb0FycmF5QnVmZmVyKHB1YktleXMuUFJFVklPVVMucGVtKVxuICAgICAgfSlcbiAgICAgIC5vbihHZXRQdWJsaWNLZXlDb21tYW5kLCB7IEtleUlkOiAnYWxpYXMvc3RzL0NVUlJFTlQnIH0pLnJlc29sdmVzKHtcbiAgICAgICAgUHVibGljS2V5OiBiYXNlNjRUb0FycmF5QnVmZmVyKHB1YktleXMuQ1VSUkVOVC5wZW0pXG4gICAgICB9KVxuICAgICAgLm9uKEdldFB1YmxpY0tleUNvbW1hbmQsIHsgS2V5SWQ6ICdhbGlhcy9zdHMvUEVORElORycgfSkucmVzb2x2ZXMoe1xuICAgICAgICBQdWJsaWNLZXk6IGJhc2U2NFRvQXJyYXlCdWZmZXIocHViS2V5cy5QRU5ESU5HLnBlbSlcbiAgICAgIH0pXG4gICAgICAub24oRGVzY3JpYmVLZXlDb21tYW5kLCB7IEtleUlkOiAnYWxpYXMvc3RzL1BSRVZJT1VTJyB9KS5yZXNvbHZlcyh7XG4gICAgICAgIEtleU1ldGFkYXRhOiB7XG4gICAgICAgICAgS2V5SWQ6ICdrZXktMSdcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5vbihEZXNjcmliZUtleUNvbW1hbmQsIHsgS2V5SWQ6ICdhbGlhcy9zdHMvQ1VSUkVOVCcgfSkucmVzb2x2ZXMoe1xuICAgICAgICBLZXlNZXRhZGF0YToge1xuICAgICAgICAgIEtleUlkOiAna2V5LTInXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAub24oRGVzY3JpYmVLZXlDb21tYW5kLCB7IEtleUlkOiAnYWxpYXMvc3RzL1BFTkRJTkcnIH0pLnJlc29sdmVzKHtcbiAgICAgICAgS2V5TWV0YWRhdGE6IHtcbiAgICAgICAgICBLZXlJZDogJ2tleS0zJ1xuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgcHJvY2Vzcy5lbnYuUzNfQlVDS0VUID0gJ3Rlc3QtYnVja2V0LW5hbWUnXG4gICAgcHJvY2Vzcy5lbnYuSVNTVUVSID0gJ3Rlc3QtaXNzdWVyLmNvbSdcblxuICAgIGF3YWl0IGhhbmRsZXIoeyBzdGVwOiAnZ2VuZXJhdGVBcnRpZmFjdHMnIH0pXG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgdGFnc1ByZXZpb3VzID0ga21zTW9jay5jYWxsKDIpLmFyZ3NbMF0uaW5wdXQuVGFnc1xuICAgIGV4cGVjdCh0YWdzUHJldmlvdXNbMF0uVGFnS2V5KS50b0JlKCdqd2tfa2lkJylcbiAgICBleHBlY3QodGFnc1ByZXZpb3VzWzBdLlRhZ1ZhbHVlKS50b0JlKHB1YktleXMuUFJFVklPVVMuandrX2tpZClcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCB0YWdzQ3VycmVudCA9IGttc01vY2suY2FsbCg1KS5hcmdzWzBdLmlucHV0LlRhZ3NcbiAgICBleHBlY3QodGFnc0N1cnJlbnRbMF0uVGFnS2V5KS50b0JlKCdqd2tfa2lkJylcbiAgICBleHBlY3QodGFnc0N1cnJlbnRbMF0uVGFnVmFsdWUpLnRvQmUocHViS2V5cy5DVVJSRU5ULmp3a19raWQpXG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgdGFnc1BlbmRpbmcgPSBrbXNNb2NrLmNhbGwoOCkuYXJnc1swXS5pbnB1dC5UYWdzXG4gICAgZXhwZWN0KHRhZ3NQZW5kaW5nWzBdLlRhZ0tleSkudG9CZSgnandrX2tpZCcpXG4gICAgZXhwZWN0KHRhZ3NQZW5kaW5nWzBdLlRhZ1ZhbHVlKS50b0JlKHB1YktleXMuUEVORElORy5qd2tfa2lkKVxuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHMzS2V5ID0gczNNb2NrLmNhbGwoMCkuYXJnc1swXS5pbnB1dC5LZXlcbiAgICBleHBlY3QoczNLZXkpLnRvQmUoJ2Rpc2NvdmVyeS9rZXlzJylcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBzM0J1Y2tldCA9IHMzTW9jay5jYWxsKDApLmFyZ3NbMF0uaW5wdXQuQnVja2V0XG4gICAgZXhwZWN0KHMzQnVja2V0KS50b0JlKCd0ZXN0LWJ1Y2tldC1uYW1lJylcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBzM0JvZHkgPSBKU09OLnBhcnNlKHMzTW9jay5jYWxsKDApLmFyZ3NbMF0uaW5wdXQuQm9keS50b1N0cmluZygpKVxuICAgIGV4cGVjdChzM0JvZHkpLnRvRXF1YWwoe1xuICAgICAga2V5czogW1xuICAgICAgICB7XG4gICAgICAgICAgZTogJ0FRQUInLFxuICAgICAgICAgIGtpZDogJ3JlTkQ5SUFJNWhqMnBlOFVmS20yWDZyLVNqVzF2N3MyM29DM19ONVdQaVEnLFxuICAgICAgICAgIGt0eTogJ1JTQScsXG4gICAgICAgICAgbjogJ3QwTy1iaU91QVlENUZyTTJSNmRBbGlOMXY5SEE1WHBzdW9BdFhUbjhPVktzTHZ2QkZFaEJGbGdodlNYUHB1NzF2RV9KWXBVajBsTDdKNTRvX1JtQ3o5WlJEem9qTFU3YVdFWU0yc0VDOW5PMklUZHU4aXQtcnIzZmFhNzAtN1BHVzA5bzRpRkQtbVhZVWdhZFlUOFZXeHJLUTNlVl9MUXJTTS02X0tZbDNCaGxOWk54d2p0YkhHV0FsZE9senZ5MTRJNTlHVTVXX3pEUGdPSVdTUUJicFJ2b0pLVDJyek9aWUR0bjdDNjIxOTdoSllBVTdRSVo0bU96X2lhMTBheUZGSTdwMlVvZ2t1M3RZNWN5WUV0U1dHemxUTDNFaUV6U3Z2c2ZRMDcxN2JBNXliYkRxQ1d0U2hnOC1Jb094bWJ5NEs5WDdYdUdBUVpZRV9mZ05BWGczdycsXG4gICAgICAgICAgYWxnOiAnUlMyNTYnLFxuICAgICAgICAgIHVzZTogJ3NpZydcbiAgICAgICAgfSwge1xuICAgICAgICAgIGU6ICdBUUFCJyxcbiAgICAgICAgICBraWQ6ICctTklKRTRSUThOWVdyT09oNV9KeUdLRkFvYmZZNV9vQ0tvMU1yTlhvUU9nJyxcbiAgICAgICAgICBrdHk6ICdSU0EnLFxuICAgICAgICAgIG46ICdfUEMzZi04WE9zNnl3YXkyRmhQTGRacldVNjdSSXFGQUNTUEowQTRxX2VKOEdsR1hEajhjeEhjSkJKeXZUeEVVX3J0dFNlM2Y0NFpmcnZ3bERVYmdBbVRpMnpZRURyQlJIci1MbVI2cW95dmN6TE5aa2lNbUpaeWdkZU9NVDg3Z1B4MWZiOGhoRkFYUWtPTDhkSEtpQlotczRIbHM4eXU1ZU11QmhqaC1oVVl4RVFXdzBpbERnYVhDYUdSam9vSFBTVTYtSS1RYm03M011Q2JCQXl6U0lBR0RLeXlENTBLeDlaOUNjMGktNlpmWHdXVV8yU2RhN3U0VTRSMkJfUGtoQXkwZklqbjdrTWF3OXNncGRRSEh4eWd4UTh5N1BkdU5nREJGX0Mxek9lS0p1UmEzUUdvTVhZOWtuX09WQnduWkc3YlE5RW56M1JuVGtNM3EwbmY5SlEnLFxuICAgICAgICAgIGFsZzogJ1JTMjU2JyxcbiAgICAgICAgICB1c2U6ICdzaWcnXG4gICAgICAgIH0sIHtcbiAgICAgICAgICBlOiAnQVFBQicsXG4gICAgICAgICAga2lkOiAnYkh5alBZQjNBZklJOG9fWDN0R2tPQ1Z6VGhaelFOMlVLd0tWQ085RTlnWScsXG4gICAgICAgICAga3R5OiAnUlNBJyxcbiAgICAgICAgICBuOiAnemVXQXQyYVJpWDU3dkRkNzhPd0YtODNJZEVJMG1XaDA1aFh2QXpRWE1xdC1RUjQ5aGlJV2pKdFloMUIzc1l2YnA5QldDOHlvLUJsV1d0c0k1ZnU1bUNYc0JCcF9RX3NnZkFyRXNqaS1kV0VYYy14R1JOM2hwdGI5dFQtc2FiSVdtZDZReXc0ZFlDa3NyQnpKdlNMTy1IaTEwT3RkMk50elliQXFqWjZzb2FhQ2xTbnJPaXc5LUo0X0dGSHVZNWdPdzhQMHVhTWNsSTVzRExHTi1HX2F5R3BVSzd4ZWdmRUFkOVZCNm1oZGdXb1lFQVQ2eUVEbkZ0MEJ3dlRPWVQ2VElfNXY2c2NSRTdCeXdzcTVWMk16NVZaZTQzUE9jU3Qxbjd2SVo5Y1hYSFNHVzhKUHYxS0tjbmlIc3hJYzNGYzc0T2pjRWJxV0t3NDlrVkdDRTNheWZRJyxcbiAgICAgICAgICBhbGc6ICdSUzI1NicsXG4gICAgICAgICAgdXNlOiAnc2lnJ1xuICAgICAgICB9XVxuICAgIH0pXG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgczNLZXlPcGVuaWRDb25maWd1cmF0aW9uID0gczNNb2NrLmNhbGwoMSkuYXJnc1swXS5pbnB1dC5LZXlcbiAgICBleHBlY3QoczNLZXlPcGVuaWRDb25maWd1cmF0aW9uKS50b0JlKCcud2VsbC1rbm93bi9vcGVuaWQtY29uZmlndXJhdGlvbicpXG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgczNCb2R5T3BlbmlkQ29uZmlndXJhdGlvbiA9IEpTT04ucGFyc2UoczNNb2NrLmNhbGwoMSkuYXJnc1swXS5pbnB1dC5Cb2R5LnRvU3RyaW5nKCkpXG4gICAgZXhwZWN0KHMzQm9keU9wZW5pZENvbmZpZ3VyYXRpb24pLnRvRXF1YWwoe1xuICAgICAgaXNzdWVyOiAndGVzdC1pc3N1ZXIuY29tJyxcbiAgICAgIGp3a3NfdXJpOiAndGVzdC1pc3N1ZXIuY29tL2Rpc2NvdmVyeS9rZXlzJyxcbiAgICAgIHJlc3BvbnNlX3R5cGVzX3N1cHBvcnRlZDogW1xuICAgICAgICAndG9rZW4nXG4gICAgICBdLFxuICAgICAgaWRfdG9rZW5fc2lnbmluZ19hbGdfdmFsdWVzX3N1cHBvcnRlZDogW1xuICAgICAgICAnUlMyNTYnXG4gICAgICBdLFxuICAgICAgc2NvcGVzX3N1cHBvcnRlZDogW1xuICAgICAgICAnb3BlbmlkJ1xuICAgICAgXSxcbiAgICAgIHRva2VuX2VuZHBvaW50X2F1dGhfbWV0aG9kc19zdXBwb3J0ZWQ6IFtcbiAgICAgICAgJ2NsaWVudF9zZWNyZXRfYmFzaWMnXG4gICAgICBdLFxuICAgICAgY2xhaW1zX3N1cHBvcnRlZDogW1xuICAgICAgICAnYXVkJyxcbiAgICAgICAgJ2V4cCcsXG4gICAgICAgICdpYXQnLFxuICAgICAgICAnaXNzJyxcbiAgICAgICAgJ3N1YidcbiAgICAgIF1cbiAgICB9KVxuICB9KVxufSlcblxuZnVuY3Rpb24gYmFzZTY0VG9BcnJheUJ1ZmZlciAoYjY0OiBzdHJpbmcpIHtcbiAgY29uc3QgYnl0ZVN0cmluZyA9IGF0b2IoYjY0KVxuICBjb25zdCBieXRlQXJyYXkgPSBuZXcgVWludDhBcnJheShieXRlU3RyaW5nLmxlbmd0aClcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlU3RyaW5nLmxlbmd0aDsgaSsrKSB7XG4gICAgYnl0ZUFycmF5W2ldID0gYnl0ZVN0cmluZy5jaGFyQ29kZUF0KGkpXG4gIH1cblxuICByZXR1cm4gYnl0ZUFycmF5XG59XG4iXX0=