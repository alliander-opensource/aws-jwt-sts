"use strict";
// SPDX-FileCopyrightText: 2023 Alliander NV
//
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
/* eslint-disable camelcase */
const jwt_decode_1 = require("jwt-decode");
const client_kms_1 = require("@aws-sdk/client-kms");
const index_sign_1 = require("../index.sign");
const kmsMock = (0, aws_sdk_client_mock_1.mockClient)(client_kms_1.KMSClient);
const VALID_IDENTITY_USER_ARN = 'arn:aws:sts:eu-central-1:123456789012:assumed-role/this-is-my-role-name/this-is-my-username';
const VALID_EVENT = {
    requestContext: {
        identity: {
            userArn: VALID_IDENTITY_USER_ARN
        }
    }
};
const CONTEXT = {};
describe('handlers/sign/sign.ts', () => {
    const OLD_ENV = process.env;
    beforeEach(() => {
        jest.resetModules();
        kmsMock.reset();
        process.env = { ...OLD_ENV };
    });
    afterEach(() => {
        kmsMock.reset();
        process.env = OLD_ENV;
    });
    test('it should respond bad request if no userIdentity is passed', async () => {
        const event = {
            requestContext: {}
        };
        const response = await (0, index_sign_1.handler)(event, CONTEXT);
        expect(response.statusCode).toEqual(400);
        expect(response.body).toEqual('Unable to resolve identity');
    });
    test('it should respond bad request if an invalid userIdentity is passed', async () => {
        const invalidServiceResponse = await (0, index_sign_1.handler)({
            requestContext: {
                identity: {
                    userArn: 'arn:aws:invalid-service:eu-central-1:123456789012:assumed-role/this-is-my-role-name/this-is-my-username'
                }
            }
        }, CONTEXT);
        expect(invalidServiceResponse.statusCode).toEqual(400);
        expect(invalidServiceResponse.body).toEqual('Unable to resolve identity');
        const invalidAccountIdResponse = await (0, index_sign_1.handler)({
            requestContext: {
                identity: {
                    userArn: 'arn:aws:sts:eu-central-1:account-id:assumed-role/this-is-my-role-name/this-is-my-username'
                }
            }
        }, CONTEXT);
        expect(invalidAccountIdResponse.statusCode).toEqual(400);
        expect(invalidAccountIdResponse.body).toEqual('Unable to resolve identity');
        const completelyInvalidArn = await (0, index_sign_1.handler)({
            requestContext: {
                identity: {
                    userArn: 'i-am-not-even-trying'
                }
            }
        }, CONTEXT);
        expect(completelyInvalidArn.statusCode).toEqual(400);
        expect(completelyInvalidArn.body).toEqual('Unable to resolve identity');
    });
    test('it should respond internal server error if no tag is present on the KMS key', async () => {
        kmsMock
            .on(client_kms_1.DescribeKeyCommand).resolves({
            KeyMetadata: {
                KeyId: 'key-1'
            }
        })
            .on(client_kms_1.ListResourceTagsCommand).resolves({
            Tags: [
                {
                    TagKey: 'NotTheKid',
                    TagValue: 'I won\'t be resolved'
                }
            ]
        });
        const response = await (0, index_sign_1.handler)(VALID_EVENT, CONTEXT);
        expect(response.statusCode).toEqual(500);
        expect(response.body).toEqual('KMS key is not correctly tagged');
    });
    test('it should respond internal server error if the KeyId is not in the metadata', async () => {
        kmsMock
            .on(client_kms_1.DescribeKeyCommand).resolves({});
        const response = await (0, index_sign_1.handler)(VALID_EVENT, CONTEXT);
        expect(response.statusCode).toEqual(500);
        expect(response.body).toEqual('KMS key could not be retrieved');
    });
    test('should sign correctly', async () => {
        jest
            .useFakeTimers()
            .setSystemTime(new Date('2020-01-01'));
        const b64Signature = Buffer.from('i-am-a-signature').toString('base64');
        const signature = base64ToArrayBuffer(b64Signature);
        kmsMock
            .on(client_kms_1.DescribeKeyCommand).resolves({
            KeyMetadata: {
                KeyId: 'key-1'
            }
        })
            .on(client_kms_1.ListResourceTagsCommand).resolves({
            Tags: [
                {
                    TagKey: 'jwk_kid',
                    TagValue: 'I am the KID from the JWK'
                }
            ]
        })
            .on(client_kms_1.SignCommand).resolves({
            Signature: signature
        });
        process.env.ISSUER = 'https://test-issuer.com';
        process.env.DEFAULT_AUDIENCE = 'api://default-aud';
        const response = await (0, index_sign_1.handler)(VALID_EVENT, CONTEXT);
        expect(response.statusCode).toEqual(200);
        const responseBody = JSON.parse(response.body);
        const token = responseBody.token;
        const decodedHeader = (0, jwt_decode_1.default)(token, { header: true });
        expect(decodedHeader.alg).toEqual('RS256');
        expect(decodedHeader.typ).toEqual('JWT');
        expect(decodedHeader.kid).toEqual('I am the KID from the JWK');
        const decodedToken = (0, jwt_decode_1.default)(token);
        expect(decodedToken.sub).toEqual('arn:aws:iam:eu-central-1:123456789012:role/this-is-my-role-name');
        expect(decodedToken.aud).toEqual('api://default-aud');
        expect(decodedToken.iss).toEqual('https://test-issuer.com');
        expect(decodedToken.exp - decodedToken.iat).toEqual(3600);
        expect(decodedToken.iat - decodedToken.nbf).toEqual(300);
        const tokenParts = responseBody.token.split('.');
        expect(tokenParts[2]).toEqual(`${b64Signature.replace('==', '')}`);
    });
});
function base64ToArrayBuffer(b64) {
    const byteString = atob(b64);
    const byteArray = new Uint8Array(byteString.length);
    for (let i = 0; i < byteString.length; i++) {
        byteArray[i] = byteString.charCodeAt(i);
    }
    return byteArray;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguc2lnbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3Rlc3QvaW5kZXguc2lnbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0Q0FBNEM7QUFDNUMsRUFBRTtBQUNGLHNDQUFzQzs7QUFHdEMsNkRBQWdEO0FBQ2hELDhCQUE4QjtBQUM5QiwyQ0FBbUM7QUFFbkMsb0RBSzRCO0FBRTVCLDhDQUF1QztBQUV2QyxNQUFNLE9BQU8sR0FBRyxJQUFBLGdDQUFVLEVBQUMsc0JBQVMsQ0FBQyxDQUFBO0FBRXJDLE1BQU0sdUJBQXVCLEdBQUcsNkZBQTZGLENBQUE7QUFFN0gsTUFBTSxXQUFXLEdBQXlCO0lBQ3hDLGNBQWMsRUFBRTtRQUNkLFFBQVEsRUFBRTtZQUNSLE9BQU8sRUFBRSx1QkFBdUI7U0FDakM7S0FDRjtDQUNLLENBQUE7QUFFUixNQUFNLE9BQU8sR0FBWSxFQUFTLENBQUE7QUFFbEMsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFBO0lBRTNCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDbkIsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2YsT0FBTyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUE7SUFDOUIsQ0FBQyxDQUFDLENBQUE7SUFFRixTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2YsT0FBTyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUE7SUFDdkIsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFJLENBQUMsNERBQTRELEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDNUUsTUFBTSxLQUFLLEdBQXlCO1lBQ2xDLGNBQWMsRUFBRSxFQUNmO1NBQ0ssQ0FBQTtRQUVSLE1BQU0sUUFB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Q0FBQTtRQUNoRCxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3BFLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUE7QUFFRixTQUFTLG1CQUFtQixDQUFFLEdBQVc7SUFDdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQzVCLE1BQU0sU0FBUyxHQUFHLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNuRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQzNDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3pDLENBQUM7SUFFRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBBbGxpYW5kZXIgTlZcbi8vXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBtb2NrQ2xpZW50IH0gZnJvbSAnYXdzLXNkay1jbGllbnQtbW9jaydcbi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqL1xuaW1wb3J0IGp3dF9kZWNvZGUgZnJvbSAnand0LWRlY29kZSdcblxuaW1wb3J0IHtcbiAgS01TQ2xpZW50LFxuICBEZXNjcmliZUtleUNvbW1hbmQsXG4gIExpc3RSZXNvdXJjZVRhZ3NDb21tYW5kLFxuICBTaWduQ29tbWFuZFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQta21zJ1xuXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vaW5kZXguc2lnbidcblxuY29uc3Qga21zTW9jayA9IG1vY2tDbGllbnQoS01TQ2xpZW50KVxuXG5jb25zdCBWQUxJRF9JREVOVElUWV9VU0VSX0FSTiA9ICdhcm46YXdzOnN0czpldS1jZW50cmFsLTE6MTIzNDU2Nzg5MDEyOmFzc3VtZWQtcm9sZS90aGlzLWlzLW15LXJvbGUtbmFtZS90aGlzLWlzLW15LXVzZXJuYW1lJ1xuXG5jb25zdCBWQUxJRF9FVkVOVDogQVBJR2F0ZXdheVByb3h5RXZlbnQgPSB7XG4gIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgaWRlbnRpdHk6IHtcbiAgICAgIHVzZXJBcm46IFZBTElEX0lERU5USVRZX1VTRVJfQVJOXG4gICAgfVxuICB9XG59IGFzIGFueVxuXG5jb25zdCBDT05URVhUOiBDb250ZXh0ID0ge30gYXMgYW55XG5cbmRlc2NyaWJlKCdoYW5kbGVycy9zaWduL3NpZ24udHMnLCAoKSA9PiB7XG4gIGNvbnN0IE9MRF9FTlYgPSBwcm9jZXNzLmVudlxuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QucmVzZXRNb2R1bGVzKClcbiAgICBrbXNNb2NrLnJlc2V0KClcbiAgICBwcm9jZXNzLmVudiA9IHsgLi4uT0xEX0VOViB9XG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBrbXNNb2NrLnJlc2V0KClcbiAgICBwcm9jZXNzLmVudiA9IE9MRF9FTlZcbiAgfSlcblxuICB0ZXN0KCdpdCBzaG91bGQgcmVzcG9uZCBiYWQgcmVxdWVzdCBpZiBubyB1c2VySWRlbnRpdHkgaXMgcGFzc2VkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCA9IHtcbiAgICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICB9XG4gICAgfSBhcyBhbnlcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgQ09OVEVYVClcblxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50b0VxdWFsKDQwMClcbiAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCgnVW5hYmxlIHRvIHJlc29sdmUgaWRlbnRpdHknKVxuICB9KVxuXG4gIHRlc3QoJ2l0IHNob3VsZCByZXNwb25kIGJhZCByZXF1ZXN0IGlmIGFuIGludmFsaWQgdXNlcklkZW50aXR5IGlzIHBhc3NlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBpbnZhbGlkU2VydmljZVJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcih7XG4gICAgICByZXF1ZXN0Q29udGV4dDoge1xuICAgICAgICBpZGVudGl0eToge1xuICAgICAgICAgIHVzZXJBcm46ICdhcm46YXdzOmludmFsaWQtc2VydmljZTpldS1jZW50cmFsLTE6MTIzNDU2Nzg5MDEyOmFzc3VtZWQtcm9sZS90aGlzLWlzLW15LXJvbGUtbmFtZS90aGlzLWlzLW15LXVzZXJuYW1lJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBhcyBhbnksIENPTlRFWFQpXG5cbiAgICBleHBlY3QoaW52YWxpZFNlcnZpY2VSZXNwb25zZS5zdGF0dXNDb2RlKS50b0VxdWFsKDQwMClcbiAgICBleHBlY3QoaW52YWxpZFNlcnZpY2VSZXNwb25zZS5ib2R5KS50b0VxdWFsKCdVbmFibGUgdG8gcmVzb2x2ZSBpZGVudGl0eScpXG5cbiAgICBjb25zdCBpbnZhbGlkQWNjb3VudElkUmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKHtcbiAgICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICAgIGlkZW50aXR5OiB7XG4gICAgICAgICAgdXNlckFybjogJ2Fybjphd3M6c3RzOmV1LWNlbnRyYWwtMTphY2NvdW50LWlkOmFzc3VtZWQtcm9sZS90aGlzLWlzLW15LXJvbGUtbmFtZS90aGlzLWlzLW15LXVzZXJuYW1lJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBhcyBhbnksIENPTlRFWFQpXG5cbiAgICBleHBlY3QoaW52YWxpZEFjY291bnRJZFJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvRXF1YWwoNDAwKVxuICAgIGV4cGVjdChpbnZhbGlkQWNjb3VudElkUmVzcG9uc2UuYm9keSkudG9FcXVhbCgnVW5hYmxlIHRvIHJlc29sdmUgaWRlbnRpdHknKVxuXG4gICAgY29uc3QgY29tcGxldGVseUludmFsaWRBcm4gPSBhd2FpdCBoYW5kbGVyKHtcbiAgICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICAgIGlkZW50aXR5OiB7XG4gICAgICAgICAgdXNlckFybjogJ2ktYW0tbm90LWV2ZW4tdHJ5aW5nJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBhcyBhbnksIENPTlRFWFQpXG5cbiAgICBleHBlY3QoY29tcGxldGVseUludmFsaWRBcm4uc3RhdHVzQ29kZSkudG9FcXVhbCg0MDApXG4gICAgZXhwZWN0KGNvbXBsZXRlbHlJbnZhbGlkQXJuLmJvZHkpLnRvRXF1YWwoJ1VuYWJsZSB0byByZXNvbHZlIGlkZW50aXR5JylcbiAgfSlcblxuICB0ZXN0KCdpdCBzaG91bGQgcmVzcG9uZCBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3IgaWYgbm8gdGFnIGlzIHByZXNlbnQgb24gdGhlIEtNUyBrZXknLCBhc3luYyAoKSA9PiB7XG4gICAga21zTW9ja1xuICAgICAgLm9uKERlc2NyaWJlS2V5Q29tbWFuZCkucmVzb2x2ZXMoe1xuICAgICAgICBLZXlNZXRhZGF0YToge1xuICAgICAgICAgIEtleUlkOiAna2V5LTEnXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAub24oTGlzdFJlc291cmNlVGFnc0NvbW1hbmQpLnJlc29sdmVzKHtcbiAgICAgICAgVGFnczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIFRhZ0tleTogJ05vdFRoZUtpZCcsXG4gICAgICAgICAgICBUYWdWYWx1ZTogJ0kgd29uXFwndCBiZSByZXNvbHZlZCdcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0pXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoVkFMSURfRVZFTlQsIENPTlRFWFQpXG5cbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9FcXVhbCg1MDApXG4gICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwoJ0tNUyBrZXkgaXMgbm90IGNvcnJlY3RseSB0YWdnZWQnKVxuICB9KVxuXG4gIHRlc3QoJ2l0IHNob3VsZCByZXNwb25kIGludGVybmFsIHNlcnZlciBlcnJvciBpZiB0aGUgS2V5SWQgaXMgbm90IGluIHRoZSBtZXRhZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICBrbXNNb2NrXG4gICAgICAub24oRGVzY3JpYmVLZXlDb21tYW5kKS5yZXNvbHZlcyh7fSlcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihWQUxJRF9FVkVOVCwgQ09OVEVYVClcblxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50b0VxdWFsKDUwMClcbiAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCgnS01TIGtleSBjb3VsZCBub3QgYmUgcmV0cmlldmVkJylcbiAgfSlcblxuICB0ZXN0KCdzaG91bGQgc2lnbiBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgamVzdFxuICAgICAgLnVzZUZha2VUaW1lcnMoKVxuICAgICAgLnNldFN5c3RlbVRpbWUobmV3IERhdGUoJzIwMjAtMDEtMDEnKSlcblxuICAgIGNvbnN0IGI2NFNpZ25hdHVyZSA9IEJ1ZmZlci5mcm9tKCdpLWFtLWEtc2lnbmF0dXJlJykudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgY29uc3Qgc2lnbmF0dXJlID0gYmFzZTY0VG9BcnJheUJ1ZmZlcihiNjRTaWduYXR1cmUpXG5cbiAgICBrbXNNb2NrXG4gICAgICAub24oRGVzY3JpYmVLZXlDb21tYW5kKS5yZXNvbHZlcyh7XG4gICAgICAgIEtleU1ldGFkYXRhOiB7XG4gICAgICAgICAgS2V5SWQ6ICdrZXktMSdcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5vbihMaXN0UmVzb3VyY2VUYWdzQ29tbWFuZCkucmVzb2x2ZXMoe1xuICAgICAgICBUYWdzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgVGFnS2V5OiAnandrX2tpZCcsXG4gICAgICAgICAgICBUYWdWYWx1ZTogJ0kgYW0gdGhlIEtJRCBmcm9tIHRoZSBKV0snXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9KVxuICAgICAgLm9uKFNpZ25Db21tYW5kKS5yZXNvbHZlcyh7XG4gICAgICAgIFNpZ25hdHVyZTogc2lnbmF0dXJlXG4gICAgICB9KVxuXG4gICAgcHJvY2Vzcy5lbnYuSVNTVUVSID0gJ2h0dHBzOi8vdGVzdC1pc3N1ZXIuY29tJ1xuICAgIHByb2Nlc3MuZW52LkRFRkFVTFRfQVVESUVOQ0UgPSAnYXBpOi8vZGVmYXVsdC1hdWQnXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoVkFMSURfRVZFTlQsIENPTlRFWFQpXG5cbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9FcXVhbCgyMDApXG4gICAgY29uc3QgcmVzcG9uc2VCb2R5ID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KVxuICAgIGNvbnN0IHRva2VuID0gcmVzcG9uc2VCb2R5LnRva2VuXG5cbiAgICBjb25zdCBkZWNvZGVkSGVhZGVyOiBhbnkgPSBqd3RfZGVjb2RlKHRva2VuLCB7IGhlYWRlcjogdHJ1ZSB9KVxuXG4gICAgZXhwZWN0KGRlY29kZWRIZWFkZXIuYWxnKS50b0VxdWFsKCdSUzI1NicpXG4gICAgZXhwZWN0KGRlY29kZWRIZWFkZXIudHlwKS50b0VxdWFsKCdKV1QnKVxuICAgIGV4cGVjdChkZWNvZGVkSGVhZGVyLmtpZCkudG9FcXVhbCgnSSBhbSB0aGUgS0lEIGZyb20gdGhlIEpXSycpXG5cbiAgICBjb25zdCBkZWNvZGVkVG9rZW46IGFueSA9IGp3dF9kZWNvZGUodG9rZW4pXG4gICAgZXhwZWN0KGRlY29kZWRUb2tlbi5zdWIpLnRvRXF1YWwoJ2Fybjphd3M6aWFtOmV1LWNlbnRyYWwtMToxMjM0NTY3ODkwMTI6cm9sZS90aGlzLWlzLW15LXJvbGUtbmFtZScpXG4gICAgZXhwZWN0KGRlY29kZWRUb2tlbi5hdWQpLnRvRXF1YWwoJ2FwaTovL2RlZmF1bHQtYXVkJylcbiAgICBleHBlY3QoZGVjb2RlZFRva2VuLmlzcykudG9FcXVhbCgnaHR0cHM6Ly90ZXN0LWlzc3Vlci5jb20nKVxuICAgIGV4cGVjdChkZWNvZGVkVG9rZW4uZXhwIC0gZGVjb2RlZFRva2VuLmlhdCkudG9FcXVhbCgzNjAwKVxuICAgIGV4cGVjdChkZWNvZGVkVG9rZW4uaWF0IC0gZGVjb2RlZFRva2VuLm5iZikudG9FcXVhbCgzMDApXG5cbiAgICBjb25zdCB0b2tlblBhcnRzID0gcmVzcG9uc2VCb2R5LnRva2VuLnNwbGl0KCcuJylcbiAgICBleHBlY3QodG9rZW5QYXJ0c1syXSkudG9FcXVhbChgJHtiNjRTaWduYXR1cmUucmVwbGFjZSgnPT0nLCAnJyl9YClcbiAgfSlcbn0pXG5cbmZ1bmN0aW9uIGJhc2U2NFRvQXJyYXlCdWZmZXIgKGI2NDogc3RyaW5nKSB7XG4gIGNvbnN0IGJ5dGVTdHJpbmcgPSBhdG9iKGI2NClcbiAgY29uc3QgYnl0ZUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYnl0ZVN0cmluZy5sZW5ndGgpXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYnl0ZVN0cmluZy5sZW5ndGg7IGkrKykge1xuICAgIGJ5dGVBcnJheVtpXSA9IGJ5dGVTdHJpbmcuY2hhckNvZGVBdChpKVxuICB9XG5cbiAgcmV0dXJuIGJ5dGVBcnJheVxufVxuIl19